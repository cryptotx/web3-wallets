<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Web3 Wallets</title>
</head>
<body>

<p>Account: <span id="accountAddr"></span></p>
chainId <span id="chainId"></span>
<hr/>
<button id="linkwalletBtn">Link Wallet</button>
<button id="switchBSCTESTBtn">Switch BSCTEST</button>
<button id="switchRinkebyBtn">Switch Rinkeby</button>
<hr/>
<button id="walletConnectBtn">Wallet Connect</button>

<button id="walletConnectSignMessage">SignMessage</button>
<button id="walletConnectSign712">SignTypedData</button>
<p>Session: <span id="walletSession"></span></p>

<script type="module">

    import {MetamaskWallet} from './js/metamask.js'
    import {WalletConnect} from './js/walletConnet.js'
    // import {CHAIN_ID_RPC} from "../index";

    window.ethers = ethers

    let accounts

    const wallet = new MetamaskWallet()

    async function init(chainId, address) {
        document.getElementById('accountAddr').innerText = address.toLowerCase()
        document.getElementById('chainId').innerText = chainId

        const authToken = localStorage.getItem('authToken')

        console.log('authToken', authToken)
        // orderApi = new ElementOrdersV2({chainId, address}, {authToken})
        // orderApi.on('Error', function (e) {
        //     debugger
        //     console.log('Error', e)
        // })

        // window.orderApi = orderApi


        const unitPrice = document.getElementById('erc1155UnitPrice').value
        const tokenAmount = document.getElementById('erc1155Amount').value

        const startAmount = document.getElementById('erc1155Price')
        startAmount.value = unitPrice * tokenAmount

        const switchBSCTESTBtn = document.getElementById('switchBSCTESTBtn')
        switchBSCTESTBtn.onclick = () => {
            wallet.switchBSCTEST()
        }
        const switchRinkebyBtn = document.getElementById('switchRinkebyBtn')
        switchRinkebyBtn.onclick = () => {
            wallet.switchRinkeby()
        }
    }

    const linkWalletBtn = document.getElementById('linkwalletBtn')
    linkWalletBtn.onclick = async () => {
        accounts = await wallet.requestAccounts() // enable ethereum
        // window.walletConnectProvider = undefined
        const chainId = wallet.chainId
        const address = wallet.account
        console.log(chainId, address)
        const walletProvider = wallet.ethereum
        window.walletSigner = new ethers.providers.Web3Provider(walletProvider).getSigner()
    }
    const walletConnectBtn = document.getElementById('walletConnectBtn')
    walletConnectBtn.onclick = async () => {
        const walletConnet = new WalletConnect()
        walletConnet.connector.on('connect', async (error, payload) => {
            if (error) {
                throw error
            }
            const web3Provider = walletConnet.wallet.walletProvider
            if (web3Provider) {
                window.walletConnectProvider = web3Provider
                const {accounts, chainId} = payload.params[0]
                init(chainId, accounts[0])
            }

        })
        if (walletConnet.connector.connected) {
            // const walletSession = JSON.stringify(walletConnet.connector.session, null, 2)
            const walletSession = walletConnet.connector.session
            console.log("walletSession", walletSession)

            document.getElementById('accountAddr').innerText = walletSession.accounts[0]
            document.getElementById('chainId').innerText = walletSession.chainId

            document.getElementById('walletSession').innerText = walletSession.peerMeta.name

            const web3Provider = getWalletConnectProvider(walletSession.chainId, walletConnet.connector)
            if (web3Provider) {
                const walletProvider = web3Provider
                window.walletSigner = new ethers.providers.Web3Provider(walletProvider).getSigner()
            }
        }

    }

    const walletConnectSignMessageBtn = document.getElementById('walletConnectSignMessage')
    walletConnectSignMessageBtn.onclick = async () => {
        const msg = prompt("sign Info")
        if (window.walletSigner) {
            debugger
            const signature = await window.walletSigner.signMessage(msg).catch((e) => {
                // this.emit('Error', e)
                throw e
            })
            alert(signature)
        }
    }

    const walletConnectSign712Btn = document.getElementById('walletConnectSign712')
    walletConnectSign712Btn.onclick = async () => {
        const msgParams = {
            types: {
                EIP712Domain: [
                    {name: 'name', type: 'string'},
                    {name: 'version', type: 'string'},
                    {name: 'chainId', type: 'uint256'},
                    {name: 'verifyingContract', type: 'address'},
                ],
                Person: [
                    {name: 'name', type: 'string'},
                    {name: 'wallet', type: 'address'},
                ],
                Mail: [
                    {name: 'from', type: 'Person'},
                    {name: 'to', type: 'Person'},
                    {name: 'contents', type: 'string'},
                ],
            },
            primaryType: 'Mail',
            domain: {
                name: 'Ether Mail',
                version: '1',
                chainId: '1',
                verifyingContract: '0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC',
            },
            message: {
                from: {
                    name: 'Cow',
                    wallet: '0xCD2a3d9F938E13CD947Ec05AbC7FE734Df8DD826',
                },
                to: {
                    name: 'Bob',
                    wallet: '0xbBbBBBBbbBBBbbbBbbBbbbbBBbBbbbbBbBbbBBbB',
                },
                contents: 'Hello, Bob!',
            },
        };
        if (window.walletSigner) {
            // signature = await this.walletProvider._signTypedData(typedData.domain, { Order: typedData.types.Order }, typedData.message)
            const signature = await window.walletSigner._signTypedData(msgParams.domain, {
                Person: msgParams.types.Person,
                Mail: msgParams.types.Mail
            }, msgParams.message).catch((e) => {
                // this.emit('Error', e)
                throw e
            })
            alert(signature)
        }
    }


</script>

</body>
</html>
